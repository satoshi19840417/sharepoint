# 承認画面の表示改善計画

## 課題

承認依頼画面（Teams/Approvals）で申請内容が正しく表示されない：

| 項目 | 現状 | あるべき姿 |
|------|------|----------|
| 品目 | 空白 | 品目名が表示 |
| 見積額 | 表示なし | 金額が表示 |
| 希望納期 | 表示なし | 日付が表示 |
| 添付ファイル | リンクのみ | PDFを直接確認可能 |

---

## 原因分析

フロー `Requests_Approval_SP` の77行目を確認：

```json
"WebhookApprovalCreationInput/details": "申請ID: @{triggerBody()?['ID']}\\n品目: @{triggerBody()?['OData__x54c1__x76ee__xff08_Lookup_xff0']?['Value']}\\n数量: @{triggerBody()?['field_5']}\\n備考: @{triggerBody()?['field_11']}"
```

**問題点:**
1. `OData__x54c1__x76ee__xff08_Lookup_xff0` - Lookup列の内部名が正しく参照できていない可能性
2. 見積額（`見積額(税込)`列）が含まれていない
3. 希望納期（`納品予定日`列）が含まれていない
4. 添付ファイルへの直接リンクがない

---

## Proposed Changes

### [MODIFY] [Requests_Approval_SPSharePoint-B7A87C05-883D-48D1-958F-15AC133EB244.json](file:///C:/Users/%E5%8D%83%E8%B3%80%E8%81%A1%E5%BF%97/OneDrive%20-%20%E3%82%BB%E3%83%AB%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%86%E3%83%83%E3%82%AF%E6%A0%AA%E5%BC%8F%E4%BC%9A%E7%A4%BE/sharepoint%E3%83%AA%E3%82%B9%E3%83%88%E5%8C%96/temp_v11/Workflows/Requests_Approval_SPSharePoint-B7A87C05-883D-48D1-958F-15AC133EB244.json)

**77行目の `details` フィールドを修正:**

```diff
- "WebhookApprovalCreationInput/details": "申請ID: @{triggerBody()?['ID']}\\n品目: @{triggerBody()?['OData__x54c1__x76ee__xff08_Lookup_xff0']?['Value']}\\n数量: @{triggerBody()?['field_5']}\\n備考: @{triggerBody()?['field_11']}"
+ "WebhookApprovalCreationInput/details": "申請ID: @{triggerBody()?['ID']}\\n品目: @{triggerBody()?['OData__x54c1__x76ee__x5fc5__x9808__x30fb']?['Value']}\\n数量: @{triggerBody()?['field_5']}\\n見積額(税込): @{triggerBody()?['field_XXX']}\\n希望納期: @{triggerBody()?['field_YYY']}\\n備考: @{triggerBody()?['field_11']}\\n\\n添付ファイルはSharePointで確認: @{triggerBody()?['OData__ui_BlobDataUrl']}"
```

> [!IMPORTANT]
> `field_XXX` と `field_YYY` は実際の内部名に置き換える必要があります。
> SharePointリスト設定でFldEdit.aspx?Field=XXXを確認してください。

---

## 確認が必要な列の内部名

| 表示名 | 想定される内部名 | 要確認 |
|-------|----------------|-------|
| 品目（必須・本命）_新 | `OData__x54c1__x76ee__x5fc5__x9808__x30fb` | ✅ |
| 見積額(税込) | `field_???` | 🔍 要調査 |
| 納品予定日 | `field_???` | 🔍 要調査 |
| 添付ファイル | `{HasAttachments}` など | 🔍 要調査 |

---

## 次のステップ

1. **SharePointリスト設定で列の内部名を確認**
   - リスト設定 → 各列をクリック → URLの `Field=` パラメータを控える

2. **確定した内部名でJSONを修正**

3. **ZIPを再パッケージしてインポート（バージョン 1.0.0.12）**

---

## Verification Plan

1. テスト用アイテムを作成（全項目入力＋PDF添付）
2. 承認依頼が届いたら表示内容を確認
3. 品目・金額・納期が正しく表示されることを検証
4. 「SharePointで確認」リンクからPDFを開けることを確認
