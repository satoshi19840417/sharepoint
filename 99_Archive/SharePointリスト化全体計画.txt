## 結論（計画内容）

この「SharePointリスト化計画」は、**SharePointリスト（発注依頼／台帳／マスタ）を基盤にして Power Automate を段階導入**し、まずは **採番・Title更新の安定化（+1で必ず進む）**を固めたうえで、**Teams通知→承認→（将来）業者別送付**へ拡張していく計画です。 

---

## 計画の全体像（フェーズ構成）

* **フェーズ1：採番の安定化（最優先）**

  * 現状課題の「採番が二重に進む」「保存エラー（依存関係）」を潰し、**1申請あたり CurrentNo が必ず +1**になる状態を作ります。 
  * 実装上の標準手順は **「Power Automate（新しいデザイナー）で無理に直さず、Antigravity側でZIP（ソリューション）編集→再インポート」**です。 

* **フェーズ2：Title（採番文字列）仕様の確定**

  * 表記（例：`YYMM-0001-CO`）を確定し、**ProjectCodeが空でも表示崩れが出ない**ようにルール化して反映します。 

* **フェーズ3：Teams通知MVP（送信状態管理含む）**

  * **SendTarget=Yes** のアイテムを検知し、Teams投稿→送信状況（SendStatus）と送信日時（SentAt）を更新、**冪等性（SendRequestId）で重複送信を防止**します。

* **フェーズ4：承認（Approvals）＋送付ゲート（統制）**

  * 承認者可変・承認後に「最終確認→送付OK」を挟む設計（2フロー化＋二重送信防止）を確定します。

* **フェーズ5：外部送付の拡張（業者別一括送信・帳票自動生成）**

  * 承認済を起点に、業者別に明細を集約して**発注書PDF／請書Excel**を生成し、メール送信＋監査証跡（送信先、添付URL等）を残します。

---

## 直近の「最短ルート」実行手順（成功判定つき）

1. **回帰テスト（3パターン）を固定して実施**

   * ①ProjectCodeあり／②ProjectCode空／③短時間に2件追加（競合チェック）
   * **成功判定**：どのケースでも *CurrentNo が必ず +1*、かつ *台帳更新が実行履歴上1回のみ*。

2. **Title仕様を確定してZIP反映**

   * 例：`YYMM-0001-CO`、空なら `YYMM-0001`（末尾ハイフン無し）
   * **成功判定**：SharePoint側でTitleが仕様どおりに安定して更新される。

3. **Teams通知MVPを設計書どおりに適用（送信状態の統一）**

   * Trigger条件、SendStatus値、Try/Catch、同時実行=1 を揃える
   * **成功判定**：SendTarget=Yes のときだけ投稿され、失敗時はSendStatus=エラー、再送待ちで再実行できる。

---

## いま計画上「確定している前提（真実の一意特定）」

* 対象リストURL（Requests_Test／Numbering_Requests）
* 列内部名（Prefix／CurrentNo／Title）がURLで確定済み
  ※同名列混在の誤参照を避けるため、この情報を起点に作業する方針です。 

---

必要なら、この計画を **「済／進行中／これから」** のチェックリスト（コピペ用）に再構成して、次回作業の手順書としてそのまま使える形にも整形できます。
