# Phase 5 発注書テンプレート修正計画 (Rev 9: Multi-Item Support)

**作成日**: 2026年2月4日
**元ファイル**: `01_Documents/02_Templates/発注書テンプレート.docx`
**必須要件**: **複数明細行（Multi-Item）対応**

---

## 1. 修正概要

発注書テンプレートに対して、以下の改修を一括で行います。

### A. ブランディング・固定情報の追記 (静的修正)
*   **ヘッダー編集**: 右上に会社情報、左上にロゴ(`logo_c.png`)。全ページヘッダー対象。
*   **挨拶文**: 本文先頭に挿入。
*   **発注依頼者**: 納品先欄の直下に `<<Orderer>>` を追記。（データソース: SharePoint「作成者 (Author)」列の表示名を使用）

### B. 複数明細対応 (動的生成ロジック)
1.  **明細行の繰り返し処理**
    *   Word: 明細表の行をアイテム数分だけ**複製 (XML Deep Copy)** して挿入。
    *   Excel: 明細行の書式・数式を維持したまま行を増やす。

---

## 2. 実装方針 (Technical Plan)

### A. テンプレート構造変更スクリプト (`modify_word_template.py`)

このスクリプトの内容は **Rev 7** (静的構造の修正) と基本的に同じですが、明細表が「複製可能」な状態であることを前提とします。

### B. 検証/生成スクリプト (`create_test_samples.py`) の大幅改修

検証スクリプトを「複数明細対応版」に書き換えます。

1.  **データ構造**:
    *   `DUMMY_DATA` (ヘッダー情報: 辞書, OrderID="PO-001", VendorID="V001")
    *   `ITEMS` (明細リスト: 辞書のリスト, 複数行用意)
    
2.  **Word生成ロジック (`populate_word_template`)**:
    *   **表の特定**: インデックス (`tables[0]`) ではなく、**各表の第1行（ヘッダー）のテキストに "ItemName" または "品名" が含まれるか** で明細表を特定します。
    *   **行の複製**:
        *   特定した表の2行目（明細テンプレート行）を `copy.deepcopy(row._element)` でクローン（要 `import copy`）。
        *   `ITEMS` のループ内で、クローンした行に値を入れ、`table._tbl.append(tr)` で追加。
    *   **計算**: 合計金額欄には、スクリプト内で計算した `Sum(Qty * UnitPrice) * 1.10` (円未満切捨) をセットします。

3.  **Excel生成ロジック (`populate_excel_template`)**:
    *   **開始行**: 10行目。
    *   **行挿入**: `ws.insert_rows(row_index, amount=1)` を使用。
    *   **書式コピー**: 元の行（テンプレート行）のセルスタイル (`font`, `border`, `fill`, `number_format`, `alignment`) を新行にコピーします。
    *   **数式**: 元の行に数式がある場合、参照を行に合わせてシフトさせてコピーするか、値として計算結果を入れます（今回は請書なので値貼り付け推奨ですが、数式維持なら `A1` 参照のシフト処理が必要）。
        *   *方針*: 今回はシンプルに **「値」** をセットします。

### C. 計算ルール (Calculation Rules)

スクリプト内で以下の計算を行い、テンプレートの「小計」「消費税」「合計」欄に埋め込みます。
*   **小計 (Subtotal)**: Σ(数量 × 単価)
*   **消費税 (Tax)**: 小計 × 0.10 ( `math.floor` で切り捨て)
*   **合計 (Total)**: 小計 + 消費税

---

## 3. 手順

1.  **テンプレート構造改修**: `modify_word_template.py` を実行 (Rev 7と同じ)。
2.  **検証スクリプト作成**: `create_test_samples.py` を Multi-Item 対応版として新規作成。
3.  **検証**:
    *   Word: 3行以上の明細を作成し、2ページ目に渡った際のヘッダー表示を確認。
    *   Excel: 3行以上の明細を作成し、罫線や書式が崩れていないか確認。

---

## 4. ユーザー確認事項

*   **Excel数式**: 請書の明細行の金額計算は、Excel数式を残すのではなく、生成時点で計算した**値**を出力します（行増減による数式参照エラー回避のため）。
*   **合計欄**: テンプレートに合計計算式がない場合、スクリプトが計算してテキストとして挿入します。
