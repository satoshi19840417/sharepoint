# Phase7 受入・出庫記録 計画書 指摘まとめ

- 日付: 2026-01-30
- 対象: 01_Documents/Phase7_受入出庫記録計画書.md（最終更新 2026-01-30）

## 最新指摘 (v3.0計画書 & スクリプト手順 2026-01-30)
1. 計画書に同一セクションが重複挿入（フロー全体像〜対象シート現状〜実装ステップの一部が二重記載＆途中に崩れたmermaid行）。版上げ時のマージミスと思われるので重複削除と見出し構造の修正が必要。
2. バーコード仕様の不整合：仕様は `MakerCode-Branch-Lot-YYMMDD` だが、実装ステップの「バーコード自動生成」では `[品目ID]-[ロット番号]-YYYYMMDD` と異なる式が残存。MakerCode/BranchNumber欠落＋日付6桁/8桁の混在を統一すること。
3. BranchNumberをキー再計算対象としながら列定義では必須「-」のまま。必須化しない場合、枝番空のままバーコードが重複するリスクが残るため、必須化方針と代替（00暫定など）を明記して整合を取ること。
4. スクリプト手順書の手順6で「受入10列・出庫9列追加」と記載されているが、直後の表では受入15列・出庫10列を定義しており整合しない。実際に作成される列数に合わせて手順書を更新すること。
5. スクリプト手順書は CompositeKey/BarcodeKey の計算ロジックや一意制約をセットする手順が記載されていないため、スクリプト実行だけではキーが空/重複を防げない。計画書のキー設計に合わせて「計算（またはPA/Flowで事前生成）＋一意制約ON」手順を追記する必要がある。

## 最新指摘 (v3.1計画書 & 手順更新 2026-01-30 再レビュー)
1. ステータス表記が依然「v3.0」のままなのに改訂履歴では3.1まで進んでおり、版整合が取れていない（計画書: `ステータス` と `改訂履歴` の不一致）。
2. BranchNumber運用が矛盾：列定義では「必須・空なら00自動セット」と記載している一方、データ整合性セクションではPhase 7で「00保存をブロック」と記載。自動00付与と00禁止が同居しており、どちらを採用するか明確化が必要。
3. BranchNumber変更時に「CompositeKeyも再計算」と明記しているが、現在のCompositeKey式 (`InventoryItemId-Lot-受入日`) にはBranchNumberが含まれておらず再計算不要。式に枝番を入れるか、再計算対象から外すかを決めて修正すること。
4. 計画書ではBranchNumberを必須○としたが、スクリプト手順書の列定義では必須空欄のまま。スクリプトで作成されるリストが計画書要件（必須化・00初期値など）を満たさないため、どちらかに合わせて統一が必要。
5. スクリプト手順書Step7でCompositeKey/BarcodeKeyの計算と一意制約を追記したが、BranchNumberを必須化・00初期値付与・00ブロック切替の手順が未記載。計画書に沿った運用フラグとデフォルト設定を追加しないとバーコード重複リスクが残る。

## 最新指摘 (implementation_plan 56b7…再確認4)
1. 重複検知方式が未統一：序文で「SharePoint一意制約＋Power Apps事前設定」に統一と明記している一方、セクション2ではPower Automateで`Status=登録失敗(重複)`を付けて残す方式を併記。どちらを採用するかを一つに決め、もう一方を削除する必要がある。
2. テスト手順が整合していない：「CompositeKey生成テスト」で「SharePoint UIから手動作成」と記載されているが、標準フォームは使用不可と明記しており矛盾。Power Appsフォーム前提のテスト手順に修正が必要。
3. Phase 6 BranchNumber必須化は影響範囲が大きいが、移行手順（既存データに00設定→製品固有値へ置換の責任者/期日/ダウンタイム有無）が未記載。運用中リストへの影響を具体化すること。
4. MakerCode重複検知フローのクエリ例が抽象的で、Power Automateの「GroupBy」が使えない制約への対処（PowerFX/Excel/外部処理など）が未記載。実装可能な手順に落とし込む必要がある。
5. BarcodeKey生成が「MakerCode-Branch-Lot-Date」固定だが、MakerCode非一意だった場合のスイッチ条件（いつ発注ID+枝番に切替えるか）の基準が未定義。判定基準と移行手順を追記すること。

## 最新指摘 (implementation_plan 56b7…再々確認)
1. 重複防止方針が二重化・矛盾：セクション1では「事前重複チェック→重複ならDelete Item・一意制約なし」と記載、一方で列定義表ではCompositeKeyに「一意制約ON」、セクション2ではStatus更新で残す方式。いずれかに統一しないと運用が混乱する。
2. 「作成→即削除」で重複をブロックする方式は同時登録でのレースに弱く、Power Automate失敗時に重複が残留するリスクがある。SharePoint側の一意制約＋登録前にCompositeKeyを埋める(Power Apps/フォーム計算)方式の方が安全。
3. MakerCodeの一意性が「確認をお願いします」となっているだけで、重複検知・整備手順が未定義。Phase 6未運用の今の段階で重複を検出・解消する計画を明文化すべき。
4. BranchNumberを受入記録で必須(デフォルト00)にしているが、Phase 6側は任意のまま。Lookup元が未設定だとBarcodeKey生成で空値となり、ラベル重複を招く。Phase 6のBranchNumberも必須化・初期値整備を合わせて記載が必要。
5. Manual Verificationで「既存データにデフォルト値が設定されていることを確認」とあり、上部の「デフォルト値なし・品目ごとに正確に設定」と矛盾。Unitの付与手順を一つに決めて記載を統一すること。

## 最新指摘 (implementation_plan 56b7...確認)
1. 列定義テーブルで「数量単位」が依然1行テキストのままで、選択肢型とする方針と矛盾。Phase 6/7間で型がズレるとLookup・集計が壊れる。
2. 「メーカーコードはPhase 6に追加必要」と記載されているが、Phase 6計画書では既にMakerCode列が定義済み。重複追加や不要な改修を招く。
3. Unit列へ既存データを一括でデフォルト「個」に設定する案は、液体や粉末の品目で誤値を大量に生む恐れ。Phase 6が未運用であれば初期登録時に正しい単位を割り当てるべき。
4. CompositeKeyを作成後に一意制約ONとし、重複時はStatusを更新するが、更新失敗（制約衝突）のリカバリ手順が未定義。重複レコードが中途半端に残るリスク。
5. バーコードキーをMakerCode+BranchNumberで構成するが、MakerCode自体がユニークである前提が未確認。同じメーカーコードで異なる製品が存在するとラベル衝突する。

## 推奨対応 (56b7...確認)
- 列定義表を修正しUnitを選択肢型に統一（Phase 6/7とも同一セット）。1行テキスト表記は削除。
- MakerCodeはPhase 6に既存である旨を明記し、追加作業を省く。必要なら一意制約または整備タスクをPhase 6側に追記。
- デフォルト「個」での一括埋めは避け、未運用の今の段階で正しい単位を品目ごとに設定する計画を明記。移行手順に「単位マッピング表」を追加。
- CompositeKey更新が一意制約で失敗した場合の処理を具体化（例: 失敗時にアイテムを自動削除し、ユーザーへ再入力指示／または事前生成で保存をブロック）。
- バーコードキーの前提として「MakerCodeは製品コードとして一意」「BranchNumberは必須かつ00初期化後に商品固有値へ置換」などユニーク性担保策を追加。ユニークでない場合は発注ID+枝番など別キーに切替を検討。

## 最新指摘 (implementation_plan v2.2再確認)
1. CompositeKey列を「必須: ○」のままPower Automate後書きにしており、SharePointフォームでは値が空で保存できず登録が失敗する。必須を外すか、Power Apps/PAで登録前に値を入れる仕組みが必要。
2. 一意制約違反時に「登録をロールバック」とあるが、具体手順（自動削除／状態フラグ付与／ユーザー通知）が未記載で、重複登録が部分的に残るリスクがある。
3. バーコードキーをMakerCode+BranchNumberとしたが、BranchNumberが任意のままでは空/ダミーで重複し得る。既存データを含めてBranchNumberを必須化するか、空時は「00」を付与するルールが必要。
4. CompositeKeyはInventoryItem.Idを使用し、バーコードはMakerCode+BranchNumberを使用する設計に分かれており、トレーサビリティの突合が複雑化する。キー体系を1種類に統一するか、対応表を明記すること。

## 推奨対応 (再確認)
- CompositeKey列の必須を解除し、Power Automateで保存前に値を設定する（またはPower Appsで事前計算）。必須にする場合は「保存前に必ず埋まる」仕組みを確実に実装。
- 一意制約違反時の処理を具体化：失敗時にアイテムを自動削除するか、`Status=登録失敗(重複)`を付与してユーザー通知を行う手順を定義。
- BranchNumberを必須化し既存データを一括補完（不明は「00」など）してからバーコード生成を有効化。
- CompositeKeyとバーコードのキー体系をどちらかに統一するか、両者の対応表（CompositeKey→バーコードキー）を計画書に追記し、運用・障害対応で参照できるようにする。

## 最新指摘 (implementation_plan v2.2確認)
1. CompositeKeyを計算列で一意制約するとしているが、SharePointは計算列に一意制約を設定できず実現不可。
2. CompositeKeyの計算式がLookup列 `[InventoryItem]` を参照しており、計算列ではLookup参照が使えないため式が保存・評価できない。
3. バーコードの「品目ID」を内部IDとすると、環境移行やリスト再作成でIDが変わり既存ラベルが無効化するリスクが高い。
4. Phase 6に追加する「数量単位」列を1行テキストで想定しており、表記揺れ（個/コ/pcs等）による集計・印刷不整合が懸念。
5. Phase 6の列追加が承認待ちのまま前提化されており、合意・担当・期限が未記載で進行リスクが残る。

## 推奨対応 (implementation_plan v2.2)
- CompositeKey用に1行テキスト列を新設し、Power Automateで保存前に値を書き込んでその列に一意制約を設定。計算列案は破棄。
- CompositeKey生成はFlow側でLookup関連フィールド値を取得して組み立てる（例: `InventoryItem.Id & "-" & LotNumber & "-" & yyyymmdd(ReceiveDate)`）。
- バーコードの品目IDは移行耐性のあるコード（例: 発注ID+枝番、またはメーカーコード+枝番）に統一し、仕様と式を更新。
- Phase 6の数量単位列は選択肢型（個/本/箱/mL/g など）で定義し、Phase 7のLookupと同じ選択肢セットを共有。
- 「Phase 6 Unit列追加」の承認結果・担当者・期限を明記し、完了チェックを実装前チェックリストに追加。

## 最新指摘 (v2.1確認)
1. 受入/出庫リストでLookup関連フィールドに「数量単位 (Unit)」を自動入力する前提だが、Phase 6 在庫管理リストに数量単位列が存在せず、参照元が欠落している。
2. 受入記録の在庫自動加算に「検査結果=合格」条件が明記されておらず、不合格/保留の受入が在庫へ反映されるリスクがある。
3. 「在庫品目+ロット番号+受入日」をユニークキーとする方針はあるが、重複検知ビューのみで強制力がなく二重登録を防止できない。
4. バーコード仕様に用いる「品目ID」がどの列を指すか未定義で、在庫管理リストのID/コード/Titleのどれを使うか不明確。

## 推奨対応 (v2.1)
- Phase 6 在庫管理リストに「数量単位 (Unit)」列を追加するか、Lookup対象を既存列（例: 包装形状/入数）に差し替えて仕様を揃える。
- 在庫加算フローを「検査結果=合格」のみ実行、保留/不合格は在庫へ反映せず要確認フラグとする条件分岐をPower Automateに追加。
- 受入記録に `CompositeKey` 計算列（=在庫品目ID & "-" & Lot & "-" & TEXT(受入日,"yyyymmdd")）を追加し、一意制約またはFlow側で重複チェックを実装。
- バーコードの「品目ID」は在庫管理リストの一意キー（IDまたは品目コード）に統一し、列名を明記して仕様表と式を更新。

## 最新指摘 (v2.0確認)
1. 出庫記録リストに「メーカー」列がなく、Lookup関連フィールド（品名・メーカー・数量単位）要件を満たしていない。
2. フェーズ前提の記述が不一致（概要は「Phase 1完了後」、フローは「Phase 6完了」、Step3は「Phase 1評価後」）。依存フェーズを統一して記載が必要。
3. 準備作業に在庫更新ログリスト作成・通知先設定が未追加。堅牢性要件(リトライ/排他/監査/通知)を担保する具体タスクをチェックリストに入れること。
4. バーコード列の自動生成ロジックが未記載（フォーマット適用方法・生成タイミング）。ラベル印刷トリガーの責任者・手段も明文化が必要。

## 推奨対応
- 出庫記録リスト: 列定義に「メーカー（1行テキスト／Lookup関連フィールド）」を追加し必須化。
- フェーズ依存: Phase 6完了を前提に統一し、概要・Step3の記述を修正。
- 準備作業: チェックリストに在庫更新ログリスト作成、通知先(メール/Teams)設定、フローの再試行/排他確認テストを追加。
- バーコード: Power Automateまたは計算列で `品目ID-ロット番号-受入日(YYYYMMDD)` を自動組成する手順と、受入登録時のラベル印刷フローを記述。

## メモ
- 2026-01-23 指摘7件は計画書v2.0で反映済み。

---

## 2026-01-30 追記（再レビュー）
- 対象: 01_Documents/Phase7_受入出庫記録計画書.md（最終更新 2026-01-30）

### 指摘事項
1. 受入記録の「メーカーコード（MakerCode）」は必須かつ在庫マスタからのスナップショットと記載されているが、Lookup関連フィールドのリストにMakerCodeが含まれておらず、入力・自動反映の手段が不明確。必須列の未入力やバーコード生成失敗リスクが残る。

### 推奨対応
- [1] Lookup関連フィールドにMakerCodeを追加するか、Power Automate/Power Appsで受入登録時に自動セットする手順を明記する。
