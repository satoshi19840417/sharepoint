# Phase8 大量データ連携 計画書レビュー

- 日付: 2026-01-30
- 対象: 01_Documents/Phase8_大量データ連携計画書.md（最終更新 2026-01-21）

## 前提（ユーザー回答）
- 週次増加: 10〜20行（目安 月40〜80行）
- 保持期間: 現状 約5年／正式ポリシー未決
- 利用可能ストア: SharePointリスト（Dataverse/SQLなし）

## 主な指摘・不足
1. 行上限リスク: 使用記録入力データは既に1,048,576行でExcel最大行数に到達。追記前提の運用は不可。
2. SharePointリスト設計: 5,000件ビューしきい値を考慮したフィルタビュー・列インデックス設計が未記載。大量取得時のタイムアウト懸念。
3. 自動追記案（オプションB）: Excel Onlineコネクタは大容量ブック更新が不可。現状ファイルへの自動追記は非現実的で、代替案が必要。
4. データ保持とアーカイブ: 保持期間と分割粒度（例: 年度別CSV/リスト分割）の方針未定。バックアップ／リストア手順も未定。
5. 棚卸突合タスク: 手段・担当・スナップショット取得時点が空欄で、実行計画として不足。

## 推奨対応
- 保持・分割方針: 年度ごとに履歴CSVをアーカイブし、SharePointリストは直近1〜2年分のみ保持。ビューは日付フィルタで常に5,000件以下に。
- 連携方式: オプションAを採用し、Power Queryで期間フィルタ＋インデックス済みビューを使用。インクリメンタル更新手順を計画書に追記。
- Excelファイル役割: 分析用の小容量キャッシュを新規作成。既存100万行ブックは「アーカイブ専用」に固定し追記しない。
- 自動化方針: Power Automateは「小容量キャッシュへの部分更新」または「SharePoint→CSVアーカイブ」に限定。実装例と制約を記載。
- 棚卸突合: 手動/自動いずれかを決定し、突合ビュー、スナップショット取得タイミング（例: 月末夜）、担当者を表形式で明記。

## 次のアクション案
- 計画書へ上記指摘と方針を反映。
- 年度別アーカイブ運用のPoC（小容量ブック＋Power Query）を実施。
- SharePointリストのインデックス列／日付フィルタビューを設計・作成。

## 追加指摘（2回目）
- 日付: 2026-01-30
- 対象: 01_Documents/Phase8_大量データ連携計画書.md

### 指摘事項
1. Excel上限到達: 現ブックは1,048,576行で追記不可。計画書に「アーカイブ専用」明記と分析用軽量ブック新設を追加すること。
2. 評価軸不足: オプションA/B/Cの比較が手動/自動のみ。データ量・処理時間・リカバリ容易性を含む評価表を追加し、A推奨の根拠を明示。
3. Power Query要件: 期間フィルタ＋インデックス付きビューで常に5,000件以下を取得する要件を必須として記載。
4. Power Automate制約: 大容量Excelを更新できないため、代替（CSVアーカイブ or 小容量キャッシュ更新）を明記し、失敗時の通知/リトライを設計。
5. オプションCの分散リスク: 検索手順・メタデータ管理（どこに何があるか）を補足しないと運用困難。対策の記述を追加。
6. 実装ステップ不足: 「アーカイブ設計決定」「参照ビュー作成」「インクリメンタル更新検証」をタスクに追加。
7. 準備作業不足: 保持期間と分割粒度、アーカイブ先（CSV/別リスト）の決定をチェックリストへ追加。

### 推奨対応アップデート
- 章立て再編: ①現状課題 ②方針（推奨A、代替B/C） ③評価軸表 ④運用・保守（アーカイブ/バックアップ/リカバリ） ⑤実装ステップ。
- データ運用: 年度別CSVアーカイブ＋直近1–2年をSharePoint保持、Power Queryは期間フィルタ取得。
- 自動化: Power Automateは小容量キャッシュ更新に限定し、タイムアウト時のリトライ・通知を設計。
- 次のアクション: 週次10–20行想定を基に年1回アーカイブ運用のPoCを実施し、結果を計画書に反映。

## 追加指摘（3回目）

- 日付: 2026-01-30
- 対象: 01_Documents/Phase8_大量データ連携計画書.md（最終更新 2026-01-30）

### 指摘事項
1. PoCセクションが重複し内容も不整合（前半5項目／後半6項目＋5,000件テスト、実施時期も「Phase7完了後1週間」vs「フェーズ2内」）。
2. リスクと対策セクションが重複（前半5件・後半7件）。後半の新規リスク「Power Automate制限超過」「既存100万行Excelの破損」が前半に未反映。
3. 既存100万行Excelを年度別に分割する具体手順が未記載。Excel Onlineで開くと失敗・破損のリスクがあり、Power Query/CSV分割等の安全手順が必要。
4. Gantt開始日が固定（2026-02-03）なのに「Phase7完了後1週間開始」との依存条件が明文化されておらず、Phase7遅延時の開始日が不明。

### 推奨対応
- PoC: 後半の6項目＋「フェーズ2内で実施」を正式版とし、重複セクションを統合。旧表にも5,000件テストを反映するか削除で一元化。
- リスク: 後半の7件をベースに1表へ集約し、Power Automate制限超過と既存Excel破損リスクを明示。影響度・対策の整合を確認。
- 100万行Excel分割手順: 例）(1) SharePointリストに年度列を追加しインデックス (2) Power Queryまたはエクスポートで年度別CSV抽出→ローカル保存→検証→Archivesへアップロード (3) 元ブックはバックアップ取得後に「参照専用」として固定。
- Gantt: Phase7完了日を T0 と置き、Phase8開始＝T0+7日とする注記を追加。日付固定で掲載するなら、遅延時の更新手順を明記。

## 追加指摘（4回目）

- 日付: 2026-01-30
- 対象: 01_Documents/Phase8_大量データ連携計画書.md（最終更新 2026-01-30）

### 指摘事項
1. 「既存100万行Excel分割の詳細手順」で、ソースをSharePointリスト前提にしているが、実際のソースは100万行Excelファイル。リストに取り込まずに安全に分割する手順（Excel→Power Queryで年度抽出→CSV出力）を明示しないと実行できない。

### 推奨対応
- 手順を「ExcelブックをPower Queryで開き、年度列追加→年度ごとにフィルタ→CSV保存」に差し替え、SharePointリストを介さない方法を明記する。必要ならPowerShell/Office Scripts代替も併記。

## 追加指摘（5回目）

- 日付: 2026-01-30
- 対象: 01_Documents/Phase8_大量データ連携計画書.md（最終更新 2026-01-30）

### 指摘事項
1. 「既存100万行Excel分割の詳細手順」セクションが依然として「SharePointリストに年度列を追加→ビュー作成→Power Queryで年度抽出」というリスト前提の流れになっており、現実のソース（100万行Excelブック）と不整合。リストへ一括取込みできない前提なら、この手順では実行不能。

### 推奨対応
- ソースをExcelブックと明示した手順に置き換える（ExcelでPower Queryを開き、年度列追加→年度でフィルタ→CSV保存→SharePoint文書ライブラリへアップロード→バックアップ）。リストを経由する場合の前提条件（インポート可否、件数制限、所要時間）を分岐で補足。

---

## 対応状況確認（5回目）

- 日付: 2026-01-30
- 確認者: AI Assistant

### 確認結果

✅ **第5回指摘は第4回で既に対応済み**

計画書（v4）の「既存100万行Excel分割の詳細手順」セクション（行519-605）を確認した結果:

1. ✅ **ソースは既存Excelファイルと明記**: 「この手順は**既存100万行Excelファイル**をソースとし、SharePointリストを経由せずに直接分割します。」（行530）
2. ✅ **SharePointリスト経由の記述は存在しない**: grep検索で「SharePointリストに年度列を追加」という記述は0件
3. ✅ **手順は正しくExcel直接分割方式**: 
   - 手順3: Power Queryで元ファイル接続（Excelブックから）
   - 手順4: 年度列を追加（Power Queryエディタで）
   - 手順5: 年度でフィルタ
   - 手順6: CSVエクスポート

### 推測される原因

指摘者が古いバージョン（v3以前）の計画書を参照している可能性があります。最新版（v4）では既に修正済みです。

### 対応不要

第4回改訂（v4）で既に完全に対応済みのため、追加の修正は不要です。

---

## 対応完了（4回目）

- 日付: 2026-01-30
- 対応者: AI Assistant
- 対応版: v4

### 実施した修正

| # | 指摘事項 | 対応内容 | 修正箇所 |
|---|---------|---------|---------|
| 1 | **100万行Excel分割手順の誤り** | SharePointリスト経由の手順を全面削除し、Excel直接分割方式に改訂。Power Query推奨手順（10ステップ）、VBAマクロ代替手順、PowerShell代替手順を追加。 | 行519-605（全面改訂） |

### 改訂履歴更新

- 版番号: v3 → v4
- 最終更新日: 2026年1月30日（第4回改訂）
- 変更内容: 「第4回指摘対応:100万行Excel分割手順を全面改訂（SharePointリスト経由→Excel直接分割方式）」

### 新しい手順の特徴

✅ **推奨手順**: Power Queryで既存Excelから直接年度別CSV分割（10ステップ）  
✅ **代替手順A**: Excel VBAマクロで分割（サンプルコード付き）  
✅ **代替手順B**: PowerShellスクリプトで分割（完全なスクリプト付き）  
✅ **トラブルシューティング**: 6種類の問題と対処方法を追加  
✅ **所要時間の目安**: 各手順の所要時間を明記

### 重要な変更点

1. **SharePointリストを経由しない**: 100万行をリストに取り込むことは非現実的（タイムアウト・容量制限）
2. **バックアップ必須**: 作業前に3箇所以上へのバックアップを必須化
3. **読み取り専用アクセス**: Power Queryで元ファイルを読み取り専用で開く
4. **3つの選択肢**: 環境や技術スキルに応じて選択可能

### 検証結果

✅ 手順は既存Excelファイルをソースとして明記  
✅ SharePointリストを経由しない方式に変更  
✅ Power Query、VBA、PowerShellの3つの手順を提供  
✅ トラブルシューティングと所要時間の目安を追加

### 次のアクション

Phase 8計画書は第4回指摘対応完了。第5回指摘は既に対応済みのため追加修正不要。次回レビューまで待機、または実装フェーズへ移行可能。

---

## 2026-01-30 追記（再レビュー）
- 対象: 01_Documents/Phase8_大量データ連携計画書.md（最終更新 2026-01-30）

### 指摘事項
1. Phase 8では「使用記録」リストと「使用日」列を前提にインデックス/ビュー/Power Query手順を設計しているが、Phase 7計画書では「使用記録は出庫記録に統合」と明記。リスト名・日付列名の前提がズレており、設計どおりに実装できない恐れがある。
2. インデックス対象として「品目ID」を指定しているが、Phase 6/7の列定義には「品目ID」列が存在しない。実際に使う列（例: `在庫品目`Lookupの内部名/ID）を明示しないとインデックス作成やフィルタ条件が確定できない。

### 推奨対応
- [1] Phase 7の採用名に合わせてPhase 8内のリスト名・列名を統一（使用記録→出庫記録、使用日→出庫日など）し、必要なら対応表を追加する。
- [2] インデックス/ビューで使う実列名（Lookup列の表示名と内部名）を明記し、フィルタ条件も同列名に合わせて更新する。
