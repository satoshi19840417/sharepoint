# 承認フェーズ（Approvals）実装チェックリスト（コピペ用）

## 0. 事前：真実の一意特定（必須）
- [ ] 画面種類を確認（どれ？）
  - [ ] Power Automate（新しいデザイナー）フロー編集画面
  - [ ] SharePoint 列設定画面（FldEdit.aspx）
  - [ ] Power Apps フォーム編集画面
  - ✅判定：今見ている画面のURL/ヘッダで上記のどれか確定できる

- [ ] 対象リストURL（AllItems.aspx）を控える
  - [ ] Requests（申請）リストURL：＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿＿
  - ✅判定：AllItems.aspx を開ける

- [ ] 承認に関わる列の「内部名（Field=）」を控える（作成後に必ず確定）
  - [ ] Title（既存）：Field=＿＿＿＿＿＿
  - [ ] 申請ステータス列：表示名＿＿＿ / Field=＿＿＿＿＿＿
  - [ ] 送付ステータス列：表示名＿＿＿ / Field=＿＿＿＿＿＿
  - [ ] SendTarget（既存）：Field=SendTarget（※既に使っているなら確認のみ）
  - ✅判定：FldEdit.aspx?…&Field=XXXX のURLを開けて Field= が取れている

- [ ] （任意）承認者ルールを参照する場合：参照先リスト名を確定
  - [ ] 承認ルール参照先リスト名：＿＿＿＿＿＿＿＿＿＿
  - ✅判定：参照先リストのAllItems.aspxを開ける


## 1. SharePoint列の追加（Requests リスト）
※「表示名」と「内部名」は別物。内部名は作成後にURLの Field= で確定して控える。
- [ ] Approvers（承認者）：人/グループ（複数可）
  - [ ] 表示名：＿＿＿＿＿ / Field=＿＿＿＿＿
- [ ] ApprovalResult（承認結果）：選択肢（未承認/承認済/却下）
  - [ ] 表示名：＿＿＿＿＿ / Field=＿＿＿＿＿
- [ ] ApprovalStatus（承認状態）：選択肢（承認待ち/処理中/完了/エラー）
  - [ ] 表示名：＿＿＿＿＿ / Field=＿＿＿＿＿
- [ ] ApprovalRequestId（承認依頼ID）：1行テキスト
  - [ ] 表示名：＿＿＿＿＿ / Field=＿＿＿＿＿
- [ ] ApprovalRequestedAt（承認依頼日時）：日時
  - [ ] 表示名：＿＿＿＿＿ / Field=＿＿＿＿＿
- [ ] ApprovalRespondedAt（承認応答日時）：日時
  - [ ] 表示名：＿＿＿＿＿ / Field=＿＿＿＿＿
- [ ] ApprovedBy（承認者実績）：人/グループ
  - [ ] 表示名：＿＿＿＿＿ / Field=＿＿＿＿＿
- [ ] ApprovalComment（承認コメント）：複数行テキスト
  - [ ] 表示名：＿＿＿＿＿ / Field=＿＿＿＿＿
- [ ] SendGate（送付ゲート）：Yes/No（承認後に送付OKを人が入れる）
  - [ ] 表示名：＿＿＿＿＿ / Field=＿＿＿＿＿

✅判定（列追加完了）：
- [ ] 追加した全列で Field= を控えた
- [ ] リストの新規/編集フォームで列が表示される（必要ならフォーム側の更新/再追加を実施）


## 2. フロー（承認）をソリューション内に作成（雛形）
フロー名（案）：Requests_Approval_StartAndWait

- [ ] トリガー：SharePoint「項目が作成または変更されたとき」
  - ✅判定：保存でき、ソリューションに含まれている

- [ ] （暫定）Trigger Conditions の方針を決める（後でZIP側で確定）
  - 方針：承認開始条件 AND ApprovalRequestId 空 AND ApprovalResult 空
  - ✅判定：条件の日本語メモが残せている（後でZIPへ反映するため）


## 3. 承認者の決定ロジック（最短）
- [ ] ルートを1つに固定（候補を並べない）
  - [ ] ルート：Approvers列（手入力 or 事前設定）をそのまま使用
  - ✅判定：Approvers が空のときの扱い（エラーで止める/通知する）を決めた

- [ ] Approversが空なら停止（エラー状態に遷移）
  - [ ] ApprovalStatus=エラー を更新
  - ✅判定：Approvers空の申請で承認が飛ばない


## 4. ロック（冪等性）更新（承認開始前に必ず実施）
- [ ] 「項目の更新」：以下をセット
  - [ ] ApprovalRequestId = guid()
  - [ ] ApprovalStatus = 承認待ち（or 処理中）
  - [ ] ApprovalRequestedAt = utcNow()
  - [ ] ApprovalResult = （空のまま）
  - ✅判定：実行履歴で、承認アクション前にこれらが更新されている


## 5. Approvals：Start and wait for an approval
- [ ] 承認タイプ（例）：Approve/Reject - First to respond（運用に合わせて確定）
- [ ] Assigned to：Approvers（人/グループ）を指定
- [ ] タイトル：例「【発注申請】{Title（採番文字列）}」
- [ ] 詳細：主要項目（PJ/品目/金額/希望納期 等）を最低限
- [ ] リンク：SharePointアイテムURL（可能なら）
✅判定：
- [ ] 承認依頼が対象者に届く
- [ ] 承認/却下の応答が取れる（フローが先に進む）


## 6. Outcome 分岐（承認／却下）
### 6-A) 承認（Approve）
- [ ] 「項目の更新」：承認結果を書き戻す
  - [ ] ApprovalResult = 承認済
  - [ ] ApprovalStatus = 完了
  - [ ] ApprovedBy = Responded by（応答者）
  - [ ] ApprovalRespondedAt = utcNow()
  - [ ] ApprovalComment = Comments（コメント）
  - [ ] SendGate = No（初期）
  - [ ] 送付ステータス（例）= 送付待ち（※自動送付はしない）
✅判定：
- [ ] 承認後、送付待ちで止まる（外部送付へ勝手に進まない）

### 6-B) 却下（Reject）
- [ ] 「項目の更新」：却下結果を書き戻す
  - [ ] ApprovalResult = 却下
  - [ ] ApprovalStatus = 完了
  - [ ] ApprovedBy / ApprovalRespondedAt / ApprovalComment を保存
  - [ ] SendTarget = false（※送付対象から外す方針の場合）
✅判定：
- [ ] 却下後、送付フローが動かない（SendTarget=false 等で制御できる）


## 7. 例外処理（失敗時に“見える化”）
- [ ] Approvals失敗／更新失敗のとき
  - [ ] ApprovalStatus = エラー
  - [ ] （任意）ErrorMessage列にエラー本文（列を追加する場合）
  - [ ] （任意）Teams/メールで運用者通知
✅判定：
- [ ] 失敗しても「何が起きたか」がリスト上で追える


## 8. エクスポート → AntigravityでZIP編集 → 再インポート（標準手順）
- [ ] ソリューションをエクスポート（Managed/Unmanagedは運用に合わせる）
- [ ] AntigravityでZIP内のWorkflows JSONを編集
  - [ ] Trigger Conditions を確定（冪等性＋状態）
  - [ ] runAfter（依存関係）を崩さない
  - [ ] 参照する内部名（Field=）を確定値で反映
- [ ] バージョンを上げて再インポート（例：1.0.0.2→1.0.0.3）
✅判定：
- [ ] インポート成功
- [ ] 接続参照が解決している
- [ ] フローをONにできる


## 9. 回帰テスト（固定 5本）
- [ ] TC-01 正常：承認（承認済→送付待ち）
- [ ] TC-02 正常：却下（却下→送付対象外）
- [ ] TC-03 冪等性：承認依頼後に編集しても承認が再送されない
- [ ] TC-04 承認者可変：Approvers変更パターンで正しい相手に届く
- [ ] TC-05 例外：Approvers空/接続失敗で ApprovalStatus=エラーになる
✅判定：
- [ ] 二重承認が起きない
- [ ] 状態遷移が設計通り（監査・運用説明ができる）


## 10. 完了条件（このフェーズのDone）
- [ ] 承認済は「送付待ち」で停止（送付ゲートへ引渡し完了）
- [ ] 却下は送付対象から外れる（誤送信の芽がない）
- [ ] 冪等性が効き、再編集・再実行で二重承認が発生しない
- [ ] 失敗時に ApprovalStatus=エラーで検知できる
