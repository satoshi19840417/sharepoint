# Phase 5: 承認後送付フロー計画書 (Multi-Item Supported)

**最終更新**: 2026年2月4日
**ステータス**: 📝 計画改定中（複数明細対応 v2）

---

## 1. 概要: 複数明細対応の方針

従来の「1行＝1発注書」の方針を変更し、**「複数行（複数品目）を1つの発注書にまとめる」** フローを採用します。

### 基本ロジック
*   **グルーピングキー**: **`OrderID` (発注ID)**
*   **トリガー**: セット内の**任意の1行**の `SendStatus` が「送付中」に変更されたら起動。
    *   **無限ループ防止 (Trigger Condition)**: トリガー設定で `「更新者がサービスアカウント(Flow実行者)でないこと」` を条件に追加し、フローによるステータス同期更新が再トリガーとならないようにします。
*   **排他制御 (重複実行回避)**: **「代表アイテム判定方式」** を採用します。
    *   **ロジック**: トリガー時に、同一 `OrderID` かつ `SendStatus`='送付中' のアイテムを全取得し、**IDが最小の行**のみが処理を続行（他の行は終了）します。
    *   **整合性確保**: 代表行のフロー内で、同一Orderの他の「送付中」以外の行も全て「送付中」に更新し、状態を同期させます。

---

## 2. フロー全体像 (Multi-Item)

```mermaid
flowchart TD
    A[承認済みアイテム] --> B[送付担当者がSharePoint更新]
    B --> C[任意の1行をSendStatus=送付中に変更]
    C --> D{フロー起動}
    D --> E[排他制御: 代表アイテム判定 (ID最小?)]
    E -->|No| X[終了 (二重実行防止)]
    E -->|Yes| F1[他アイテムを「送付中」に更新]
    F1 --> F[同一OrderIDのアイテムを全取得]
    F --> G{データ整合性チェック}
    G -->|NG (Vendor不一致等)| G1[全行のSendStatus=エラー]
    G -->|OK| H[業者マスタ情報取得]
    H --> I[発注書PDF生成 (繰り返し行あり)]
    I --> J[請書Excel生成 (繰り返し行あり)]
    J --> K[メール送信 (1通)]
    K -->|成功| L[全行のSendStatus=送付済]
    K -->|失敗| M[全行のSendStatus=エラー]
```

---

## 3. 追加・変更される列定義

### 新規追加/必須化
| 列名 | 内部名 | 型 | 説明 |
|------|--------|----|------|
| **発注ID** | **OrderID** | テキスト | **必須**。同一発注をまとめるキー（例: PO-20260204-001）。 |
| 納品先 | DeliveryAddress | テキスト | ヘッダー情報（**全行で完全一致必須**）。 |
| 業者ID | VendorID | テキスト | **全行で完全一致必須**。 |
| SortOrder | SortOrder | 数値 | (任意) 明細の並び順。指定なければID/作成日時順。 |

---

## 4. 処理ロジック詳細

### A. データ取得と整合性チェック
1.  **取得条件**: `OrderID` が一致する全アイテムを取得。
2.  **代表行の選定**: `SortOrder` 昇順、または `ID` 昇順の**先頭行**をヘッダー情報の代表とします。
3.  **整合性チェック (Validation)**:
    *   **VendorID**: 全行で同一であること。
    *   **DeliveryAddress**: 全行で同一であること。
    *   *不一致の場合*: 処理を中断し、全対象行の `SendStatus` を「エラー」にし、ログに「データ不整合: VendorIDが混在」等を記録。

### B. 計算ルール 
(テンプレート生成時に適用)
*   **小計**: 各行の `Quantity` * `UnitPrice` の総和。
*   **消費税**: 小計 * 0.10 (標準税率10%固定とする、円未満切り捨て)。
*   **合計**: 小計 + 消費税。

---

## 5. テンプレート差し込み仕様 (変更)

### Wordテンプレート (発注書)
*   **表の特定**: `doc.tables[0]` などのインデックス依存は避け、**"ItemName"** という文字が含まれるヘッダー行を持つ表を検索して特定します。
*   **明細部**: 特定した表に対し、アイテム数分だけ行を複製・挿入します。

### Excelテンプレート (請書)
*   **行複製**: 10行目（書式設定済み明細行）をコピーして挿入し、書式を維持します。
*   **値のセット**: 数式は使用せず、Pythonスクリプト側で計算した**「値」**を直接セルに書き込みます（行増減による数式参照エラー回避のため）。

---

## 6. 生成ファイル管理

*   **命名**: `発注書_[OrderID]_[VendorID].pdf`
*   **保存先**: `/Shared Documents/送付済/yyyy年/MM月/`
