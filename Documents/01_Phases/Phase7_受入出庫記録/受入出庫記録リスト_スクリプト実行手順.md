# 受入・出庫記録リスト - スクリプト実行手順書

**対象サイト**: https://cellgentech.sharepoint.com/sites/SP__Prototype  
**作成日**: 2026年1月23日  
**スクリプト**: `Scripts\CreateReceiptIssueLists.ps1`

---

## 概要

PowerShellスクリプトを使用して、「受入記録」および「出庫記録」リストを自動作成します。

---

## 前提条件

- [ ] Phase 6の「在庫管理」リストが作成済みであること
- [ ] PowerShell 5.1以上がインストールされていること
- [ ] SharePointサイトへの編集権限があること

---

## 実行手順

### Step 1: スクリプトの配置確認

以下のパスにスクリプトがあることを確認：
```
C:\Users\千賀聡志\OneDrive - セルジェンテック株式会社\sharepointリスト化\Scripts\CreateReceiptIssueLists.ps1
```

### Step 2: PowerShellを管理者として起動

1. スタートメニューで「PowerShell」を検索
2. **「Windows PowerShell」** を右クリック
3. **「管理者として実行」** を選択

### Step 3: 実行ポリシーの確認・変更

PowerShellウィンドウで以下のコマンドを実行：

```powershell
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
```

プロンプトが表示されたら「Y」を入力してEnter。

### Step 4: スクリプトの実行

以下のコマンドをコピー&ペーストして実行：

```powershell
cd "C:\Users\千賀聡志\OneDrive - セルジェンテック株式会社\sharepointリスト化\Scripts"
.\CreateReceiptIssueLists.ps1
```

### Step 5: ログイン

スクリプトが3つの方法でログインを試みます：

1. **Interactive（対話型）**: ブラウザが自動的に開きます
2. **DeviceLogin（デバイスログイン）**: コードが表示されます
   - https://microsoft.com/devicelogin を開く
   - 表示されたコードを入力
   - Microsoft 365アカウントでログイン

### Step 6: 実行結果の確認

スクリプトが以下を実行します：

1. ✓ 「在庫管理」リストの存在確認
2. ✓ 「受入記録」リスト作成
3. ✓ 「受入記録」の列追加（15列）
4. ✓ 「出庫記録」リスト作成
5. ✓ 「出庫記録」の列追加（10列）

成功すると以下のメッセージが表示されます：

```
✓ ALL DONE!
Created lists:
  1. 受入記録 (Receipt Records)
  2. 出庫記録 (Issue Records)
```

Enterキーを押して終了します。

### Step 7: キー計算ロジックと一意制約の設定

スクリプトは「列の作成」のみを行います。以下の設定を手動（またはPower Automate）で行ってください。

1.  **CompositeKeyの一意制約設定**:
    *   受入記録リスト設定 → 列「CompositeKey」 → 「この列に固有の値を強制する」を「はい」に設定。
2.  **計算ロジックの実装 (Power Automate推奨)**:
    *   **トリガー**: アイテム作成時・更新時
    *   **処理**:
        *   `CompositeKey` = `InventoryItem ID` + "-" + `LotNumber` + "-" + `Format(ReceiveDate, "yyyymmdd")`
        *   `BarcodeKey` = `MakerCode` + "-" + `BranchNumber` + "-" + `LotNumber` + "-" + `Format(ReceiveDate, "yymmdd")`
        *   各列を更新して保存
3.  **枝番 (BranchNumber) の初期値設定**:
    *   受入記録リスト設定 → 列「枝番」→ 「既定値」に `00` を入力して保存。
4.  **枝番・メーカーコード列の必須化**:
    *   受入記録リスト設定 → 列「枝番」→ 「この列に情報が入っている必要があります」を「はい」に設定。
    *   列「メーカーコード」も同様に必須（「はい」）に設定。

---

## トラブルシューティング

### エラー: "在庫管理 list not found"

**原因**: Phase 6の「在庫管理」リストが作成されていません。

**解決策**: 先にPhase 6を完了させてください。

### エラー: "Cannot bind argument to parameter 'Path'"

**原因**: スクリプトファイルが見つかりません。

**解決策**: 
1. スクリプトのパスを確認
2. `cd` コマンドで正しいディレクトリに移動

### エラー: "PnP.PowerShell module not found"

**原因**: PnP.PowerShellモジュールがインストールされていません。

**解決策**: スクリプトが自動でインストールを試みます。失敗した場合は手動で：

```powershell
Install-Module -Name PnP.PowerShell -Scope CurrentUser -Force
```

### ログインに失敗する

**解決策**:
1. Interactive方式で失敗した場合は、DeviceLoginを待つ
2. ブラウザで既にSharePointにログインしている場合は、一度ログアウト
3. 多要素認証（MFA）が有効な場合は、認証アプリで承認

---

## 作成されるリスト構成

### 受入記録リスト

| 列名 | 型 | 必須 |
|------|-----|------|
| 品名 | テキスト | ○ |
| 受入日 | 日付 | ○ |
| 在庫品目 | ルックアップ | ○ |
| メーカー | テキスト | ○ |
| メーカーコード | テキスト | ○ |
| 枝番 | テキスト | ○ |
| 数量単位 | テキスト | ○ |
| ロット番号 | テキスト | ○ |
| 数量 | 数値 | ○ |
| 使用期限 | 日付 | |
| 検査結果 | 選択肢 | ○ |
| 担当者 | ユーザー | ○ |
| 備考 | 複数行テキスト | |
| 複合キー | テキスト | ○ |
| バーコード | テキスト | |

### 出庫記録リスト

| 列名 | 型 | 必須 |
|------|-----|------|
| 品名 | テキスト | ○ |
| 出庫日 | 日付 | ○ |
| 在庫品目 | ルックアップ | ○ |
| 受入記録 | ルックアップ | |
| ロット番号 | テキスト | ○ |
| 数量 | 数値 | ○ |
| 用途 | 選択肢 | ○ |
| 使用者 | ユーザー | ○ |
| 試験番号 | テキスト | |
| 備考 | 複数行テキスト | |

---

## 実行後の確認チェックリスト

- [ ] SharePointサイトで「受入記録」リストが表示される
- [ ] SharePointサイトで「出庫記録」リストが表示される
- [ ] 「在庫品目」列で「在庫管理」リストの項目が選択できる
- [ ] 「検査結果」の選択肢（合格/不合格/保留）が表示される
- [ ] 「用途」の選択肢（製造/試験/検査/研究開発/サンプル提供/廃棄/その他）が表示される

---

## 次のステップ

1. テストデータの登録
2. 在庫管理リストとの連携確認
3. 運用開始

---

## 関連ドキュメント

- [Phase7_受入出庫記録計画書.md](./Phase7_受入出庫記録計画書.md)
- [受入出庫記録リスト_手動作成手順.md](./受入出庫記録リスト_手動作成手順.md)
- [Phase6_在庫管理リスト計画書.md](../Phase6_在庫管理リスト/Phase6_在庫管理リスト計画書.md)
