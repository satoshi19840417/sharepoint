# SharePoint承認フロー：数量・見積額が0になる問題の解決

**作成日**: 2026年1月19日  
**作成者**: 千賀聡志  
**ステータス**: ✅ 解決済み

---

## 問題の概要

SharePointリスト「発注依頼_Requests_Test」で新規アイテムを作成し、数量と見積額を入力しても、承認通知（Teams/メール）では値が0と表示され、SharePointの値も0に上書きされていた。

---

## 根本原因

**2つのPower Automateフローが関係していた：**

### 1. 「発注リスト更新」フロー（主原因）

- **役割**: 新規アイテム作成時に発注番号（Title）を自動採番
- **問題点**: 「項目の更新1」アクションで`field_5`（注文数）に式を設定していたが、トリガー時点ではデータが空/nullのため、常に0が設定されていた

```
// 問題のあった式
if(
  or(
    equals(triggerBody()?['field_5'], null),
    equals(string(triggerBody()?['field_5']), '')
  ),
  0,
  int(float(triggerBody()?['field_5']))
)
```

### 2. 「Requests_Approval_SP」フロー（副因）

- **役割**: 承認ワークフロー
- **問題点**: 承認後の「項目の更新」アクションで`field_5`と`field_6`を含めていなかったため、SharePointの必須フィールドバリデーションでデフォルト値(0)に上書きされる可能性があった

---

## 解決策

### 1. 「発注リスト更新」フローの修正

「項目の更新1」アクションから**「注文数」フィールドを削除**した。

> SharePointのPatchItem APIは、指定されていないフィールドは元の値を維持するため、注文数フィールドを指定しないことで入力値が保持される。

### 2. 「Requests_Approval_SP」フローの修正

以下の3つの更新アクションに`field_5`と`field_6`を追加：

| アクション | 追加したフィールド |
|------------|-------------------|
| 承認済み更新 | `item/field_5`, `item/field_6` |
| 保留更新 | `item/field_5`, `item/field_6` |
| 却下更新 | `item/field_5`, `item/field_6` |

**修正版**: `automation_1_0_0_23.zip`

---

## 関連ファイル

| ファイル | 場所 | 説明 |
|----------|------|------|
| automation_1_0_0_23.zip | `sharepointリスト化\` | 修正版の承認フローパッケージ |
| Requests_Approval_SP | Power Automate | SharePoint承認フロー |
| 発注リスト更新 | Power Automate | 発注番号採番フロー |

---

## SharePointリストのフィールド対応表

| 表示名 | 内部名 | 型 | 必須 |
|--------|--------|-----|------|
| 注文数 | field_5 | 数値 | はい |
| 見積額(税込) | field_6 | 数値 | いいえ |
| 承認ステータス | field_8 | 選択肢 | - |
| 仕入先/入力日 | field_1 | 日付 | - |

---

## 注意事項

1. **Power Appsカスタムフォーム**: 一時的に「既定のSharePointフォームを使用する」に変更してテストを行った。本番運用時はカスタムフォームの設定確認が必要。

2. **フローの依存関係**:
   - 「発注リスト更新」をオフにすると、発注番号（Title）が生成されない
   - 承認フローはTitleを使用するため、「発注リスト更新」がオフだとエラーになる

3. **同時実行の制限**: 両フローともconcurrency=1で設定されている

---

## 動作確認結果

| 項目 | 結果 |
|------|------|
| フォームで数量入力 | ✅ 正常に保存 |
| 承認通知に数量表示 | ✅ 正しい値が表示 |
| 承認後のSharePoint値 | ✅ 維持される |
| 見積額も同様 | ✅ 正常 |

---

## 今後の改善提案

1. フィールド内部名をわかりやすい名前に変更（field_5 → Quantity など）
2. フローのエラーハンドリング強化
3. 承認フローと採番フローの統合検討
