## 承認フェーズ（Approvals）実装 計画書（社内用・たたき台）

* 対象：SharePoint リスト（例：Requests_Test）を起点にした **申請→承認/却下→状態更新→送付ゲートへ引き渡し**
* 前提：**Power Automate（新しいデザイナー）で無理に直さず、Antigravity 側でZIP（ソリューション）編集 → 再インポート** を標準手順
* 位置づけ：タスク一覧の **タスク11（承認フロー雛形）** と、追加タスクの **タスク16（承認者可変＋送付ゲート）** を「最短ルート1本」で実装する計画

---

## 1. 結論（このフェーズのゴール）

* **承認者を可変**にしつつ、Power Automate の Approvals で **承認/却下を確実に記録**できる状態を作ります。
* 承認後にいきなり外部送付へ進めず、**「送付待ち」で止めるゲート**（人の最終確認）に引き渡します（統制・誤送信防止）。
* 二重承認・二重実行を避けるため、**冪等性キー（ApprovalRequestId 等）＋状態遷移**で再実行耐性を持たせます。

---

## 2. スコープ

### 対象（この計画に含む）

* Requests（例：Requests_Test）に、承認管理用の列を追加（承認者、承認結果、承認日時、コメント、冪等性キー 等）
* **承認フロー（Start and wait for an approval）** をソリューションに実装
* 承認結果に応じた **SharePoint ステータス更新**（承認済／却下／エラー）
* 承認済の後は **送付待ち** に遷移（送付ゲートへ）

### 対象外（次フェーズ）

* 業者別の帳票生成（PDF/Excel）や外部メール送信の本実装（※承認後送付の本格化は別フェーズで段階導入）
* Power BI 等の分析基盤

---

## 3. 実装開始前の「真実の一意特定」（必須）

※ここは“計画書に埋めるべき確定情報”です。**推測で内部名を使わない**前提にします。

| 区分      | 確定すべき情報                            | 例（既に分かっているもの）                                       |
| ------- | ---------------------------------- | --------------------------------------------------- |
| リストURL  | 対象リスト（Requests）の AllItems.aspx URL | Requests_Test：`…/Lists/Requests_Test/AllItems.aspx` |
| 列の内部名   | 承認で使う列（既存＋新規）の **Field=**          | 例：Title は `Field=Title`（既知）                         |
| 参照先リスト名 | 承認者ルールをリスト参照にする場合の参照先              | （例：承認ルールマスタ、プロジェクトマスタ 等）                            |

> 参考：現状の確定情報として、Requests_Test / Numbering_Requests のURL、Prefix/CurrentNo/Title の内部名は手元資料に記載済みです（sharepointリスト情報.txt）。

---

## 4. データ設計（列追加：Requests側）

「既存列に近い概念がある場合は流用」しますが、**承認フェーズの事故（再実行・二重承認・監査説明不能）を防ぐため、最低限の専用列は追加**します。

### 4.1 追加推奨列（Requests）

| 表示名（案）                      | 種別          | 用途                  | 内部名（作成後に必ず Field= で確定） |
| --------------------------- | ----------- | ------------------- | ---------------------- |
| 承認者（Approvers）              | 人/グループ（複数可） | 可変承認者の格納（ルール結果の保存）  | Approvers（例）           |
| 承認結果（ApprovalResult）        | 選択肢         | 承認済／却下／未承認          | ApprovalResult（例）      |
| 承認状態（ApprovalStatus）        | 選択肢         | 承認待ち／処理中／完了／エラー     | ApprovalStatus（例）      |
| 承認依頼ID（ApprovalRequestId）   | 1行テキスト      | 冪等性キー（GUID）         | ApprovalRequestId（例）   |
| 承認依頼日時（ApprovalRequestedAt） | 日時          | 証跡                  | ApprovalRequestedAt（例） |
| 承認応答日時（ApprovalRespondedAt） | 日時          | 証跡                  | ApprovalRespondedAt（例） |
| 承認者（実績）（ApprovedBy）         | 人/グループ      | 実際に承認/却下した人         | ApprovedBy（例）          |
| 承認コメント（ApprovalComment）     | 複数行テキスト     | Approvals のコメントを保存  | ApprovalComment（例）     |
| 送付ゲート（SendGate）             | Yes/No      | 承認後に「送付OK」を人が入れるフラグ | SendGate（例）            |

> 例え話：**ApprovalRequestId は「伝票の受付番号」**のようなものです。これが空でない限り「同じ申請を二重に受付しない」制御ができます。

---

## 5. 状態遷移（最短ルート・統制重視）

承認と送付を分けるため、状態は最低限こう切ります（追加タスク16の趣旨に合わせます）。

* 申請系：`申請中 → 承認待ち →（承認済 / 却下）`
* 送付系：`送付待ち → 送付中 → 送付済（失敗：エラー）`

**承認フェーズの完了条件**

* ApprovalResult=承認済 のとき：SendStatus（または相当列）が **「送付待ち」**になって止まる（自動送付しない）
* ApprovalResult=却下 のとき：送付対象から外れる（SendTarget=false 等）

---

## 6. フロー設計（承認フロー：最短ルート1本）

### フロー名（案）

* `Requests_Approval_StartAndWait`

### トリガー（推奨）

* SharePoint：**項目が作成または変更されたとき**

  * 理由：作成直後に下書き編集がある運用でも拾えるため
  * ただし、**トリガー条件（Trigger Conditions）で絞り込み**ます

### トリガー条件（例：冪等性＋状態）

* 「申請中（または承認開始条件のステータス）」
* かつ `ApprovalRequestId` が空
* かつ `ApprovalResult` が空（未承認）
* （必要に応じて）SendTarget=true

### 処理ステップ（概略）

1. **（承認者決定）** Approvers 列を確定（ルール or 手入力列を採用）
2. **（ロック）** `ApprovalRequestId=guid()`、`ApprovalStatus=承認待ち`、`ApprovalRequestedAt=utcNow()` を更新
3. **Start and wait for an approval**

   * タイトル：`【発注申請】{Title（採番文字列）}` 等
   * 詳細：PJ、品目、金額、希望納期など（過不足は後で調整）
   * リンク：SharePoint アイテムURL
4. **Outcome 分岐**

   * 承認：`ApprovalResult=承認済`、`ApprovedBy`、`ApprovalRespondedAt`、`ApprovalComment`、`（送付待ちへ）`
   * 却下：`ApprovalResult=却下`、`ApprovedBy`、`ApprovalRespondedAt`、`ApprovalComment`、`SendTarget=false` 等
5. **例外処理（失敗時）**

   * `ApprovalStatus=エラー`、`ErrorMessage`（列を設ける場合）を更新し、Teams/メールで運用者へ通知

---

## 7. 実装手順（標準：ZIP編集→再インポート、成功判定つき）

> 候補は並べず、最短の1ルートだけを記載します。

1. **画面の種類を確認**（誤操作防止）

   * 作業画面が「Power Automate（新しいデザイナー）のフロー編集」かを確認
   * **成功判定**：対象フロー名／ソリューション名が見えている（Power Apps/SharePoint列設定画面ではない）

2. **SharePoint列を追加**（設計どおり）

   * 4章の列を Requests に作成
   * **成功判定**：各列の列設定URLで `Field=` が確認でき、内部名を控えられている

3. **ソリューションに“雛形フロー”を追加**（UIは最小限）

   * Approvals を1回置くところまで作り、接続参照が解決できる形にする
   * **成功判定**：フローが保存でき、ソリューションに含まれている

4. **ソリューションをエクスポート → ZIPを Antigravity で編集**

   * Trigger Conditions、冪等性（ApprovalRequestId）、runAfter（依存関係）、例外処理を **ZIP側で確定**
   * **成功判定**：編集差分が説明でき、Workflows JSON に狙いの修正が入っている

5. **ZIPを再インポート（バージョンを上げる）**

   * 例：v1.0.0.2 → v1.0.0.3
   * **成功判定**：インポート成功、接続参照が正しく割り当てられ、フローをONにできる

6. **回帰テスト（承認MVP）**

   * **成功判定**：二重承認なし、承認/却下で状態が意図通り更新される（8章のテストケース参照）

---

## 8. テスト計画（3〜5本に固定）

1. **正常：承認**

   * 申請→承認→ApprovalResult=承認済→送付待ちで停止
2. **正常：却下**

   * 申請→却下→ApprovalResult=却下→送付対象から外れる
3. **冪等性：同一アイテムを再編集**

   * 承認依頼後に編集しても **再度承認が飛ばない**（ApprovalRequestId が効く）
4. **承認者可変：ルール変更**

   * 承認者が変わる条件で Approvers が期待通りになる
5. **例外：Approvals 失敗**

   * 権限/接続問題などで失敗しても ApprovalStatus=エラーになり、運用者が検知できる

---

## 9. 運用・統制（最低限）

* **承認者の権限設計**：承認者列の編集権限（誰が変えられるか）を決める
* **監査証跡**：承認者・承認日時・コメント・ApprovalRequestId を残す（説明可能性の担保）
* **外部送付の統制**：承認後も自動送付しない（送付ゲートで止める）

  * 外部送付の自動化可否は、一般的には情報システム/購買/法務の規程・契約条件に左右される可能性があるため、最終判断は社内専門家確認が必要です。

---

## 10. 変更管理（再発防止の運用ルール）

* 修正は原則 **ZIP（ソリューション）編集 → 再インポート**
* **バージョンは必ずインクリメント**（例：1.0.0.3）
* 「直前のZIP」を必ず保管し、ロールバック可能にする

---

必要であれば、次のメッセージでこの計画書を「実装チェックリスト（コピペ用）」に落とし込みます。特に **追加した列の内部名（Field=）** が揃うと、承認フローの Trigger Conditions／更新先を“確定値”で書き切れるため、手戻りが大幅に減ります。
